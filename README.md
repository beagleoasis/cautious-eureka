# 증권사 OPEN API를 이용한 자동 매수/매도 서비스 

## 1. 프로젝트 : Rich Beagle
* 증권사 커뮤니티 기능과 [OPEN API](https://apiportal.koreainvestment.com/apiservice/oauth2#L_5c87ba63-740a-4166-93ac-803510bb9c02)를 이용한 자체 제작 주식 자동 매수/매도 서비스

<img src="https://github.com/beagleoasis/rich-beagle-read-me/blob/main/images/KakaoTalk_20241217_191402255.jpg?raw=true" width="250" height="300"/>

## 2. 구성
* **안드로이드 App(Kotlin)**
  * **나의 매수 금액 관리**
    * 매수 금액/투자금 설정 조회
    * 1회 최저 매수 금액 설정
    * 1회 최대 매수 금액 설정
    * 나의 총 투자금 규모 설정
  * **잔고 조회 관리**
    * 잔고 조회
    * 계좌 예수금 조회
    * 증권사 유저 보유 수량 수동 설정 
  * **안전 매도 모드 관리**
    * 안전 모드 ON 목록 조회
    * 안전 모드 STATUS 조회
    * 안전 매도 ON/OFF 설정
    * 전체 안전 매도 타입 조회
    * 안전 매도 타입 설정(ALL/HALF/QUARTER)
  * **양전(+) 매도 모드 관리**
    * 양전 매도 모드 상태 조회
    * 양전 매도 모드 ON/OFF
    * 양전 매도 타입 설정(ALL/HALF/QUARTER)
  * **손익 조회 관리**
    * 국내 주식 손익 조회
    * 해외 주식 손익 조회
  * **팔로우 유저 관리**
    * 팔로우 유저 조회
    * 국내 팔로우 유저 추가
    * 해외 팔로우 유저 추가
  * **거래 관리**
    * 팔로우 거래 ON/OFF 설정
    * 국내 주식 거래 ON/OFF 설정
    * 해외 주식 거래 ON/OFF 설정 
  * **수동 주문**
    * 커뮤니티 수동 주문
    * 한국투자증권 수동 주문
  * **보유 주식 조건 주문**
    * 조건 주문 내역 조회
    * 조건 주문 MODE ON/OFF
    * 조건 주문 설정 
* **텔레그램**
  * 안드로이드 App의 요청 수신
* **파이썬 서버(Flask)**
  * **Notification REST API 서버**
  * **Scheduler**
    * 주식 잔고 내역 update
    * 안전 매도
    * 양전 알림
  * **Telegram Message Reader**
    * 텔레그램 메시지 기반 REST API 전송
 
## 3. 대표 기능 
* **Telegram 서버를 이용한 외부망<->내부망 API 통신**
* [**자체 제작 한국투자증권 OpenAPI 라이브러리**](https://wikidocs.net/165190)
  * 한국투자증권의 OpenAPI 존재
  * 초기에는 이를 편리하게 이용할 수 있는 모히또 라이브러리 사용
  * 하지만, 라이브러리 에러 존재 및 미국 주식 API의 미흡으로, **직접 사용할 API를 라이브러리 형식**으로 모듈화 
* **방어 로직**
  * **안전 매도**
    * 보유 주식이 일정 수익률 이하로 떨어지는 경우 **최소 이익을 보장하기 위해 매도하는 로직**
    * 보유 주식의 수익률이 3% 이상, 전일 거래량 대비 1% 이상, 안전 매도 모드 ON일 때 작동
    * ALL, HALF, QUARTER 설정 가능 
  * **투자금 대비 비율 보정**
    * 커뮤니티 유저와 나의 투자금 규모 및 주식 매수 총액을 비교해, **나의 최대 매수 금액 비율을 보정하는 로직**
    * 예)유저와 나의 총 투자금이 각각 5억, 1천만 원이고, 유저의 총 매수 총액이 1억일 때, 1천만 원의 20%인 2백만 원을 매수 
  * **오알림 필터링**
    * 커뮤니티 오류로, 10초 내 **동일 알림이 중복해서 오는 경우를 방지하는 로직**
    * 인메모리 캐시 Map을 생성 후 key=메시지, value=알림 발생 시간으로 설정 
    * 예)A유저가 B주식을 1,000주 구매한 알림이 10초 내 중복해서 오는 경우, 첫 번째 알림만 매수 기능 수행
* **유저 정보 변경 탐지 크롤링**
  * 팔로우 유저의 정보 변경 사항을 탐지하고 자동 반영하는 기능
  * 팔로우 유저는 본인의 거래 내역 공개/비공개 선택 가능
  * 팔로우 유저는 자신의 프로필 이름을 변경 가능
  * 이를 자동으로 반영 및 알림 전송하기 위해 ChromeDriver를 설치 후
    1. 증권사 login session 크롤링
    2. 가져온 session을 통해 증권사의 유저 정보 API 조회
    3. 변동 사항이 있는 경우, 텔레그램 알림 전송 및 변경 사항 DB 반영
   
## 4. 트러블 슈팅
* **안드로이드 앱->내부망 서버 요청 보안 처리**
  * 문제 상황 : 안드로이드 앱 개발에 따라, **외부에서 내부망에 있는 파이썬 서버로의 요청과 응답**이 필요
  * 해결책
    1. 공유기 방화벽 설정 + Token 방식
       1. 사용해보았던 방식
       2. 보안 관리의 번거로움 
    3. Serverless 이용(AWS-람다, Google-Cloud Function)
       1. API 호출 횟수 제한
       2. 메모리 사용 시간 제한 
    4. **텔레그램 이용(높은 보안, 간단 구현)**
       1. 안드로이드 앱에서 텔레그램 봇으로 나에게 메시지 전송(외부망)
       2. 파이썬으로 현재 서버의 텔레그램 메시지를 이벤트 트리거로 파악(내부망)
       3. 파악된 메시지를 파이썬 Flask 서버로 REST API 전송(내부망)
* **REST API & Scheduler 간 동시성 문제**
  * 문제 상황 : 자제 제작 증권사 OpenAPI 모듈을 사용 중, 여러 작업의 동시 요청이 발생하는 경우 거래소 코드, 주식 티커 등이 변질되는 **동시성 문제** 발생
  * 원인 : REST API 담당 로직과 Scheduler 로직이 동일한 OpenAPI 객체를 사용
  * 해결책
    1.  thread lock
    2.  message queue
    3.  **REST API 객체와 Scheduler 객체를 각각 생성**
      * 가장 간단한 방법
      * 두 객체의 역할이 다르므로, 별도의 객체를 가지고 있는 것이 옳다고 판단
* **안드로이드 알림 MQ**
  * 문제 상황 : 유저의 매수/매도 알림이 단시간(1초 내)에 수십 개의 요청이 발생하며 알림 전송 누락
  * 원인 : 다수 요청 동시 발생으로 인한 **동시성 문제로 Notification Event Trigger가 오작동 발생**
  * 해결책
    1. thread pool을 사용하여, 매번 새로운 thread를 사용하지 않도록 처리
    2. thread 최대 개수 설정
    3. 알림 발생 시 queue에 적재 후 FIFO 처리

## 5. 배운점
* **주식 투자의 원칙**
  1. 국장을 하지 마라.
  2. 제1 원칙을 고수하라
  3. 제2 원칙을 잊지 마라.

